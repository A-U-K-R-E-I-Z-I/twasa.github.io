<!DOCTYPE html>
<html lang="en-us">

<head>
<meta charset="utf-8" />
<meta name="author" content="" />
<meta name="description" content="William&#39;s blog." />
<meta name="keywords" content="blog, tech" />
<meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
<meta name="generator" content="Hugo 0.26" />

<link rel="canonical" href="https://twasa.github.io/post/mongodb/">
<base href="https://twasa.github.io/" />
<meta property="og:title" content="Mongodb" />
<meta property="og:description" content="install  Create a /etc/yum.repos.d/mongodb-org-3.4.repo  [mongodb-org-3.4] name=MongoDB Repository baseurl=https://repo.mongodb.org/yum/redhat/$releasever/mongodb-org/3.4/x86_64/ gpgcheck=1 enabled=1 gpgkey=https://www.mongodb.org/static/pgp/server-3.4.asc   yum  yum install -y mongodb-org  config  default path /etc/mongod.
# security db.createUser( { user: &quot;帳號&quot;, pwd: &quot;密碼&quot;, roles: [ { role: &quot;userAdminAnyDatabase&quot;, db: &quot;admin&quot; } ] } ) security.authorization : enabled   selinux semanage port -a -t mongod_port_t -p tcp 27017  shell connection mongo --port 27017 -u &quot;unitadmin&quot; -p &quot;xyz123&quot; --authenticationDatabase &quot;test&quot;  list current using db db  列出資料庫清單 show dbs  切換資料庫 use 資料庫名稱  驗證 db." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://twasa.github.io/post/mongodb/" />



<meta property="article:published_time" content="2017-09-11T15:54:35&#43;08:00"/>
<meta property="article:modified_time" content="2017-09-11T15:54:35&#43;08:00"/>











<meta name="twitter:card" content="summary"/><meta name="twitter:title" content="Mongodb"/>
<meta name="twitter:description" content="install  Create a /etc/yum.repos.d/mongodb-org-3.4.repo  [mongodb-org-3.4] name=MongoDB Repository baseurl=https://repo.mongodb.org/yum/redhat/$releasever/mongodb-org/3.4/x86_64/ gpgcheck=1 enabled=1 gpgkey=https://www.mongodb.org/static/pgp/server-3.4.asc   yum  yum install -y mongodb-org  config  default path /etc/mongod.
# security db.createUser( { user: &quot;帳號&quot;, pwd: &quot;密碼&quot;, roles: [ { role: &quot;userAdminAnyDatabase&quot;, db: &quot;admin&quot; } ] } ) security.authorization : enabled   selinux semanage port -a -t mongod_port_t -p tcp 27017  shell connection mongo --port 27017 -u &quot;unitadmin&quot; -p &quot;xyz123&quot; --authenticationDatabase &quot;test&quot;  list current using db db  列出資料庫清單 show dbs  切換資料庫 use 資料庫名稱  驗證 db."/>



<meta itemprop="name" content="Mongodb">
<meta itemprop="description" content="install  Create a /etc/yum.repos.d/mongodb-org-3.4.repo  [mongodb-org-3.4] name=MongoDB Repository baseurl=https://repo.mongodb.org/yum/redhat/$releasever/mongodb-org/3.4/x86_64/ gpgcheck=1 enabled=1 gpgkey=https://www.mongodb.org/static/pgp/server-3.4.asc   yum  yum install -y mongodb-org  config  default path /etc/mongod.
# security db.createUser( { user: &quot;帳號&quot;, pwd: &quot;密碼&quot;, roles: [ { role: &quot;userAdminAnyDatabase&quot;, db: &quot;admin&quot; } ] } ) security.authorization : enabled   selinux semanage port -a -t mongod_port_t -p tcp 27017  shell connection mongo --port 27017 -u &quot;unitadmin&quot; -p &quot;xyz123&quot; --authenticationDatabase &quot;test&quot;  list current using db db  列出資料庫清單 show dbs  切換資料庫 use 資料庫名稱  驗證 db.">


<meta itemprop="dateModified" content="2017-09-11T15:54:35&#43;08:00" />
<meta itemprop="wordCount" content="345">



<meta itemprop="keywords" content="Database,NoSQL," />


<link rel="stylesheet" href="css/layout.css" />
<link rel="stylesheet" href="css/color-dark.css" />



<title>


     Mongodb 

</title>

<script src="js/highlight.min.js"></script>
<link rel="stylesheet" href="css/tomorrow-night.min.css" />
<script>hljs.initHighlightingOnLoad();</script>

</head>


<body>
<div class="main">
<header>

<div class="header-bar">

  <nav>
    <div class="siteTitle">
      <a href="https://twasa.github.io/">William&#39;s Blog</a>
    </div> 

    
    
    <a class="nav-item" href="https://twasa.github.io/post/"><div class="nav-item-title">Posts</div></a>
    
    <a class="nav-item" href="https://twasa.github.io/about/"><div class="nav-item-title">About</div></a>
    
    <a class="nav-item" href="https://twasa.github.io/tags/"><div class="nav-item-title">Tags</div></a>
    

  </nav>
</div>

  
<div class="social-links-header">

  

  
  <a href="https://github.com/twasa" target="_blank"><div class="social-link">GitHub</div></a>
  

  

  

  

</div>


</header>


<article class="post">
    <h1 class="title"> Mongodb </h1>
    <div class="content"> 

<h2 id="install">install</h2>

<ul>
<li>Create a /etc/yum.repos.d/mongodb-org-3.4.repo</li>
</ul>

<pre><code>[mongodb-org-3.4]
name=MongoDB Repository
baseurl=https://repo.mongodb.org/yum/redhat/$releasever/mongodb-org/3.4/x86_64/
gpgcheck=1
enabled=1
gpgkey=https://www.mongodb.org/static/pgp/server-3.4.asc
</code></pre>

<ul>
<li>yum</li>
</ul>

<pre><code>yum install -y mongodb-org
</code></pre>

<h2 id="config">config</h2>

<ul>
<li><p>default path /etc/mongod.</p>

<pre><code># security
db.createUser(
{
 user: &quot;帳號&quot;,
 pwd: &quot;密碼&quot;,
 roles: [ { role: &quot;userAdminAnyDatabase&quot;, db: &quot;admin&quot; } ]
}
)
security.authorization : enabled
</code></pre></li>
</ul>

<h2 id="selinux">selinux</h2>

<pre><code>semanage port -a -t mongod_port_t -p tcp 27017
</code></pre>

<h2 id="shell">shell</h2>

<h3 id="connection">connection</h3>

<pre><code>mongo --port 27017 -u &quot;unitadmin&quot; -p &quot;xyz123&quot; --authenticationDatabase &quot;test&quot;
</code></pre>

<h3 id="list-current-using-db">list current using db</h3>

<pre><code>db
</code></pre>

<h3 id="列出資料庫清單">列出資料庫清單</h3>

<pre><code>show dbs
</code></pre>

<h3 id="切換資料庫">切換資料庫</h3>

<pre><code>use 資料庫名稱
</code></pre>

<h3 id="驗證">驗證</h3>

<pre><code>db.auth('account', 'password')
</code></pre>

<h3 id="顯示協助訊息">顯示協助訊息</h3>

<pre><code>help
</code></pre>

<h3 id="列出資料表">列出資料表</h3>

<pre><code>show collections
</code></pre>

<h3 id="列出collection-資料筆數">列出collection 資料筆數</h3>

<pre><code>db.products.count()
</code></pre>

<h3 id="crud">CRUD</h3>

<pre><code>example:
db.collectionname.find(
  {name: &quot;william&quot;},    #query
  {Name:1, address:1}   #projection
  ).limit(5)            #modifier
</code></pre>

<h3 id="mongo-dbname-eval-db-dropdatabase-移除-database-或者下面這種方式">mongo <dbname> &ndash;eval &ldquo;db.dropDatabase()&rdquo; 移除 database。 或者下面這種方式：</h3>

<pre><code>&gt; use mydb;
&gt; db.dropDatabase();
</code></pre>

<h3 id="離開mongo-shell">離開mongo Shell</h3>

<pre><code>exit
</code></pre>

<h3 id="直接執行">直接執行</h3>

<pre><code>mongo 資料庫名稱 --eval &quot;語法&quot;
mongo test --eval &quot;db.egame.findOne()&quot;
mongo test --eval 'db.egame.remove({&quot;createDateTime&quot; : {$lt : ISODate(&quot;2017-06-10T13:56:00.001Z&quot;)}})'
</code></pre>

<h3 id="使用js-file帶入語法">使用js file帶入語法</h3>

<pre><code>mongo &lt; script.js
//script.js 內容
db.mycollection.findOne()
db.getCollectionNames().forEach(function(collection) {
  print(collection);
});
</code></pre>

<h2 id="account-and-permission">account and permission</h2>

<h3 id="show-accounts">show accounts</h3>

<pre><code>show users
</code></pre>

<h3 id="create-account-for-db-backup">create account for db backup</h3>

<pre><code>use 要備份的資料庫名稱
db.createUser(
  {
    user: &quot;帳號&quot;,
    pwd: &quot;密碼&quot;,
    roles: [ { role: &quot;backup&quot;, db: &quot;admin&quot; } ]
  }
)
</code></pre>

<h3 id="for-db-only-account">for db only account</h3>

<pre><code>use 資料庫名稱
db.createUser({
  user: &quot;帳號&quot;,
  pwd: &quot;密碼&quot;,
  roles: [
    { role: &quot;userAdmin&quot;, db: &quot;bet_collection&quot; },
    { role: &quot;readWrite&quot;, db: &quot;bet_collection&quot; },
    { role: &quot;dbAdmin&quot;, db: &quot;bet_collection&quot; }
  ]
});

db.createUser({
  user: &quot;帳號&quot;,
  pwd: &quot;密碼&quot;,
  roles: [
    { role: &quot;readWrite&quot;, db: &quot;bet_collection&quot; },
  ]
});

db.updateUser(
   &quot;betadmin&quot;,
   {
     roles : [
     { role: &quot;userAdmin&quot;, db: &quot;bet_collection&quot; },
     { role: &quot;readWrite&quot;, db: &quot;bet_collection&quot; },
     { role: &quot;dbAdmin&quot;, db: &quot;bet_collection&quot; }
             ],
     pwd: &quot;密碼&quot;
    }
)


db.removeUser(帳號)
</code></pre>

<h2 id="enable-on-config-file">enable on config file</h2>

<pre><code>security:
  authorization: enabled # 前面要空白,不然服務會無法啟動
</code></pre>

<h2 id="compare-with-relational-database">compare with relational database</h2>

<table>
<thead>
<tr>
<th>MongoDB</th>
<th>MySQL</th>
</tr>
</thead>

<tbody>
<tr>
<td>collections</td>
<td>tables</td>
</tr>

<tr>
<td>documents</td>
<td>rows</td>
</tr>
</tbody>
</table>

<h2 id="backup-and-restore">backup and restore</h2>

<ul>
<li>backup</li>
</ul>

<pre><code>mongodump --gzip --archive=backup-file-name --db db-name --collection collection-name -q &quot;&quot;
mongodump -d bet_collection -c egame -q '{&quot;createDateTime&quot;:{$gte:ISODate(&quot;2017-06-11T00:00:00.000Z&quot;)}}' --gzip --archive=/tmp/backup.tgz

--out filename

mongodump -u$mongo_user -p$mongo_secret \
-d $db -c $collection \
--queryFile $DIR/query.json \
--gzip --archive=&quot;/tmp/${collection}-backup-${dumpdate}.tgz&quot;

query.json 內容
{&quot;createDateTime&quot;:{$gte:ISODate(&quot;YYYY-MM-DDT00:00:00.000Z&quot;)}}
</code></pre>

<ul>
<li>restore</li>
</ul>

<pre><code>mongorestore --db db-name --collection collection-name filename
mongorestore --archive=filename --gzip
</code></pre>

<h2 id="roles">Roles</h2>

<ul>
<li>refernece <a href="https://docs.mongodb.com/manual/reference/built-in-roles/">https://docs.mongodb.com/manual/reference/built-in-roles/</a></li>
</ul>

<pre><code>read：允許帳號讀取指定資料庫
readWrite：允許帳號讀寫指定資料庫
backup,retore:允許備份、還原，在db.createUser()方法中roles里面的db必須是admin資料庫，不然會錯誤
dbAdmin：允許帳號在指定資料庫中執行管理函數，如索引建立、删除，查看統計或訪問system.profile
userAdmin：允許帳號向system.users這個collection寫入，可以找指定資料庫裡建立、刪除與管理帳號
clusterAdmin：只在admin資料庫中可用，赋予帳號所有分片和复制集相关函数的管理權限。
readAnyDatabase：只在admin資料庫中可用，赋予用户所有資料庫的讀取權限
readWriteAnyDatabase：只在admin資料庫中可用，赋予用户所有資料庫的读写權限
userAdminAnyDatabase：只在admin資料庫中可用，赋予用户所有資料庫的userAdmin權限，
dbAdminAnyDatabase：只在admin資料庫中可用，赋予用户所有資料庫的dbAdmin權限。
root：只在admin資料庫中可用。等於最高權限帳號
</code></pre>

<h2 id="remove">remove</h2>

<pre><code>yum erase $(rpm -qa | grep mongodb-org)
rm -r /var/log/mongodb
rm -r /var/lib/mongo
</code></pre>
 </div>
    <footer class="post-footer">

  <div class="post-footer-data">
    
<div class="tags">
    
      <div class="tag">
        <a href="https://twasa.github.io/tags/database">#Database</a>
      </div>
    
      <div class="tag">
        <a href="https://twasa.github.io/tags/nosql">#NoSQL</a>
      </div>
    
</div>

    <div class="date"> Sep 11, 2017 </div>
  </div>

</footer>


  



</article>

  <footer>

  <div class="social-links-footer">

  

  
  <a href="https://github.com/twasa" target="_blank"><div class="social-link">GitHub</div></a>
  

  

  

  

  <div class="social-link">
  <a href="https://twasa.github.io/index.xml" target="_blank">RSS</a>
  </div>

</div>


  <div class="copyright"> Copyright (c) 2017, all rights reserved. </div>

  <div class="poweredby">
    Powered by <a href="https://gohugo.io/">Hugo</a>.
  </div>

  </footer>

</body>
</html>

